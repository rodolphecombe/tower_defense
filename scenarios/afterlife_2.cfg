[multiplayer]
    id=tower_defense_afterlife_2
    name= _ "Tower Defense Afterlife (variant)"
    define=TOWER_DEFENSE_AL2
    description= _ "Versus Tower Defense adapted to Wesnoth. Recruit units, place them on hexes, they fight against waves of your opponent's towers, each enemy unit killed gives you gold, each unkilled enemy will attack your crystal once. Try to have your crystal to stand longer as the one of your opponent.

Recommanded parameters:
    - Long: Starting Gold: 100, Kill Gold: 4, Enemy gold: 50
    - Normal: Starting Gold: 80, Kill Gold: 3, Enemy Gold: 60
    - Quick: Starting Gold: 60, Kill Gold: 2, Enemy Gold: 80"
   {~add-ons/Tower_Defense/generator.cfg}

   random_start_time="no"

    {DEFAULT_SCHEDULE}
    {DEFAULT_MUSIC_PLAYLIST}

    [options]
        [slider]
            id=starting_gold
            name=_"Starting Gold"
            default=80
            min=50
            max=150
        [/slider]
        [slider]
            id=kill_gold
            name=_"Kill gold"
            description=_ "Amount of gold you receive for each enemy killed"
            default=3
            min=1
            max=5
        [/slider]
        [slider]
            id=gold_increase
            name=_"Gold Increase"
            description=_"Additional amount of gold the enemy leader gets each wave"
            default=60
            min=40
            max=100
        [/slider]
    [/options]

    [side]
        side=1
        controller=human
        team_name=human_1
        user_team_name= _ "Player 1"
        team_lock=yes
        [status]
            unhealable=yes
        [/status]
        id=crystal_1
        type=Tower TD
        leader_lock=yes
        gold=0
        income=-2
        fog=no
    [/side]

    [side]
        side=2
        no_leader=yes
        controller_lock=yes
        team_lock=yes
        faction_lock=yes
        gold_lock=yes
        income_lock=yes
        controller=ai
        team_name=human_1
        user_team_name= _ "Towers 1"
        fog=no
    [/side]

    [side]
        side=3
        controller=human
        team_name=human_2
        user_team_name= _ "Player 2"
        team_lock=yes
        [status]
            unhealable=yes
        [/status]
        id=crystal_2
        type=Tower TD
        leader_lock=yes
        gold=0
        income=-2
        fog=no
        x,y=1,1
    [/side]

    [side]
        side=4
        no_leader=yes
        controller_lock=yes
        team_lock=yes
        faction_lock=yes
        gold_lock=yes
        income_lock=yes
        controller=ai
        team_name=human_2
        user_team_name= _ "Towers 2"
        fog=no
    [/side]

    [side]
        side=5
        no_leader=yes
        allow_player=yes
        controller=ai
        team_name=human_2
        team_lock=yes
        user_team_name= _ "Enemies 1"
        income=-2
        gold=0
        fog=no
    [/side]

    [side]
        side=6
        no_leader=yes
        allow_player=yes
        controller=ai
        team_name=human_1
        team_lock=yes
        user_team_name= _ "Enemies 2"
        income=-2
        gold=0
        fog=no
    [/side]

    [event]
        name=prestart

        [gold]
            side=1,3
            amount=$starting_gold
        [/gold]

        #prepare the castles
        [store_starting_location]
            side=1
            variable=side_1_location
        [/store_starting_location]

        [store_starting_location]
            side=2
            variable=side_2_location
        [/store_starting_location]

        [if]
            [variable]
                name=side_1_location.y
                less_than=20
            [/variable]
            [then]
                [if]
                    [variable]
                        name=side_1_location.x
                        less_than=14
                    [/variable]
                    [then]
                        [terrain]
                            [filter_adjacent_location]
                                x,y=$side_1_location.x,$side_1_location.y
                                adjacent=nw
                            [/filter_adjacent_location]
                            terrain=Rr^Cov
                        [/terrain]
                    [/then]
                    [elseif]
                        [variable]
                            name=side_1_location.x
                            greater_than=26
                        [/variable]
                        [then]
                            [terrain]
                                [filter_adjacent_location]
                                    x,y=$side_1_location.x,$side_1_location.y
                                    adjacent=ne
                                [/filter_adjacent_location]
                                terrain=Rr^Cov
                            [/terrain]
                        [/then]
                    [/elseif]
                    [else]
                        [terrain]
                            [filter_adjacent_location]
                                x,y=$side_1_location.x,$side_1_location.y
                                adjacent=n
                            [/filter_adjacent_location]
                            terrain=Rr^Cov
                        [/terrain]
                    [/else]
                [/if]
            [/then]
            [else]
                [if]
                    [variable]
                        name=side_1_location.x
                        less_than=14
                    [/variable]
                    [then]
                        [terrain]
                            [filter_adjacent_location]
                                x,y=$side_1_location.x,$side_1_location.y
                                adjacent=sw
                            [/filter_adjacent_location]
                            terrain=Rr^Cov
                        [/terrain]
                    [/then]
                    [elseif]
                        [variable]
                            name=side_1_location.x
                            greater_than=26
                        [/variable]
                        [then]
                            [terrain]
                                [filter_adjacent_location]
                                    x,y=$side_1_location.x,$side_1_location.y
                                    adjacent=se
                                [/filter_adjacent_location]
                                terrain=Rr^Cov
                            [/terrain]
                        [/then]
                    [/elseif]
                    [else]
                        [terrain]
                            [filter_adjacent_location]
                                x,y=$side_1_location.x,$side_1_location.y
                                adjacent=s
                            [/filter_adjacent_location]
                            terrain=Rr^Cov
                        [/terrain]
                    [/else]
                [/if]
            [/else]
        [/if]

        {VARIABLE wave_turn 0}
        {VARIABLE wave_number 1}

        [store_locations]
            variable=map
        [/store_locations]

        [replace_map]
            map_data="{~add-ons/Tower_Defense/maps/versus.map}"
            expand=yes
        [/replace_map]

        [foreach]
            array=map
            [do]
                [terrain]
                    x,y=$this_item.x,$this_item.y
                    terrain=$this_item.terrain
                [/terrain]
                {VARIABLE plop $this_item.x}
                {VARIABLE_OP plop add 42}
                [terrain]
                    x=$plop
                    y=$this_item.y
                    terrain=$this_item.terrain
                [/terrain]
            [/do]
        [/foreach]

        [terrain]
            x=41,42
            terrain=Mm^Xm
        [/terrain]

        {VARIABLE plop $side_1_location.x}
        {VARIABLE_OP plop add 42}
        [teleport]
            [filter]
                x,y=1,1
            [/filter]
            x=$plop
            y=$side_1_location.y
        [/teleport]

        [objectives]
            side=1,3
            [objective]
                description= _ "Survive longer than your opponent. Next wave in $wave_turn| turns."
                condition=win
            [/objective]
            [objective]
                description= _ "Destruction of the crystal"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT}
        [/objectives]

        [micro_ai]
            side=5
            ai_type=assassin
            action=add

            [filter]
                canrecruit=no
            [/filter]
            [filter_second]
                id=crystal_1
            [/filter_second]
        [/micro_ai]

        [micro_ai]
            side=6
            ai_type=assassin
            action=add

            [filter]
                canrecruit=no
            [/filter]
            [filter_second]
                id=crystal_2
            [/filter_second]
        [/micro_ai]
    [/event]

   	[event]
        name=start
        [lua]
            code = <<
            wesnoth.dofile("~add-ons/Tower_Defense/lua/main.lua")
            >>
        [/lua]
        [message]
            speaker=narrator
            message=_"Welcome to this tower defense."
        [/message]
        [message]
            speaker=narrator
            message=_"To place a tower, recruit it and move it to the wanted hex.
It will then be transfered to the allied AI. It will return to its hex after each attack."
        [/message]
        [message]
            speaker=narrator
            message=_"You can change its advancement path at any time if you activated the option, even if it is now controlled by the AI."
        [/message]
        [message]
            speaker=narrator
            message=_"You can move and sell towers with a right-click."
        [/message]
        [message]
            speaker=narrator
            message=_"Enemies will spawn every 10 turns.  Each wave will have more enemies than the previous one."
        [/message]
        [message]
            speaker=narrator
            message=_"Each unit a tower kills will grant you gold."
        [/message]
        [message]
            speaker=narrator
            message=_"If your crystal is destroyed, you lose."
        [/message]
       	#move the tower menu
        [set_menu_item]
            id=1move
            description=_"Move the tower (10 gold)"
            use_hotkey=yes
            [show_if]
                [variable]
                    name=side_number
                    equals=1
                [/variable]
                [variable]
                    name=gold_1
                    greater_than=9
                [/variable]
                [have_unit]
                    side=2
                    x,y=$x1,$y1
                [/have_unit]
            [/show_if]
            [command]
                [store_unit]
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    variable=unit_to_move
                [/store_unit]
                [micro_ai]
                    side=2
                    ai_type=return_guardian
                    action=delete
                    ca_id=ca_id="micro_ai_$unit_to_move.id|"
                [/micro_ai]
                {CLEAR_VARIABLE unit_to_move}
                [modify_unit]
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    side=1
                    attacks_left=0
                    moves=20
                [/modify_unit]
                {MOVE_UNIT x,y=$x1,$y1 $side_1_location.x $side_1_location.y}
                [gold]
                    side=1
                    amount=-10
                [/gold]
                [store_gold]
                    side=1
                    variable=gold_1
                [/store_gold]
            [/command]
        [/set_menu_item]
        [set_menu_item]
            id=2move
            description=_"Move the tower (10 gold)"
            use_hotkey=yes
            [show_if]
                [variable]
                    name=side_number
                    equals=3
                [/variable]
                [variable]
                    name=gold_2
                    greater_than=9
                [/variable]
                [have_unit]
                    side=4
                    x,y=$x1,$y1
                [/have_unit]
            [/show_if]
            [command]
                [store_unit]
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    variable=unit_to_move
                [/store_unit]
                [micro_ai]
                    side=4
                    ai_type=return_guardian
                    action=delete
                    ca_id=ca_id="micro_ai_$unit_to_move.id|"
                [/micro_ai]
                {CLEAR_VARIABLE unit_to_move}
                [modify_unit]
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    side=3
                    attacks_left=0
                    moves=20
                [/modify_unit]
                {VARIABLE plop $side_1_location.x}
        		{VARIABLE_OP plop add 42}
                {MOVE_UNIT x,y=$x1,$y1 $plop $side_1_location.y}
                [gold]
                    side=3
                    amount=-10
                [/gold]
                [store_gold]
                    side=3
                    variable=gold_2
                [/store_gold]
            [/command]
        [/set_menu_item]

        #sell the tower menu
        [set_menu_item]
            id=1sell
            description=_"Sell the tower"
            use_hotkey=yes
            [show_if]
                [variable]
                    name=side_number
                    equals=1
                [/variable]
                [have_unit]
                    side=2
                    x,y=$x1,$y1
                [/have_unit]
            [/show_if]
            [command]
                [store_unit]
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    kill=no
                    variable=unit_to_sell
                [/store_unit]
                [message]
                    speaker=narrator
                    message=_"The tower will be sold for $($unit_to_sell.cost/2) gold. Do you confirm?"
                    [option]
                        message=_"Yes"
                        [command]
                            [kill]
                                id=$unit_to_sell.id
                            [/kill]
                            [gold]
                                side=1
                                amount=$($unit_to_sell.cost/2)
                            [/gold]
                            [floating_text]
                                x,y=$x1,$y1
                                text=_ "<span color='yellow'>+$($unit_to_sell.cost/2) gold</span>"
                            [/floating_text]
                            {CLEAR_VARIABLE unit_to_sell}
                            [store_gold]
                                side=1
                                variable=gold_1
                            [/store_gold]
                        [/command]
                    [/option]
                    [option]
                        message=_"No"
                        [command]
                        [/command]
                    [/option]
                [/message]
            [/command]
        [/set_menu_item]
        [set_menu_item]
            id=2sell
            description=_"Sell the tower"
            use_hotkey=yes
            [show_if]
                [variable]
                    name=side_number
                    equals=3
                [/variable]
                [have_unit]
                    side=4
                    x,y=$x1,$y1
                [/have_unit]
            [/show_if]
            [command]
                [store_unit]
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    kill=no
                    variable=unit_to_sell
                [/store_unit]
                [message]
                    speaker=narrator
                    message=_"The tower will be sold for $($unit_to_sell.cost/2) gold. Do you confirm?"
                    [option]
                        message=_"Yes"
                        [command]
                            [kill]
                                id=$unit_to_sell.id
                            [/kill]
                            [gold]
                                side=3
                                amount=$($unit_to_sell.cost/2)
                            [/gold]
                            [floating_text]
                                x,y=$x1,$y1
                                text=_ "<span color='yellow'>+$($unit_to_sell.cost/2) gold</span>"
                            [/floating_text]
                            {CLEAR_VARIABLE unit_to_sell}
                            [store_gold]
                                side=3
                                variable=gold_2
                            [/store_gold]
                        [/command]
                    [/option]
                    [option]
                        message=_"No"
                        [command]
                        [/command]
                    [/option]
                [/message]
            [/command]
        [/set_menu_item]
    [/event]

    [event]
        name=turn refresh, recruit
        first_time_only=no
        [switch]
            variable=side_number
            [case]
                value=1
                [store_gold]
                    side=1
                    variable=gold_1
                [/store_gold]
            [/case]
            [case]
                value=3
                [store_gold]
                    side=3
                    variable=gold_2
                [/store_gold]
            [/case]
        [/switch]
    [/event]

    #allows to place the towers where you want    
    [event]
        name=recruit
        first_time_only=no
        [filter]
            side=1,3
        [/filter]
        [modify_unit]
            [filter]
                id=$unit.id
            [/filter]
            moves=20
        [/modify_unit]
    [/event]

    #units move back to there position after attack
    [event]
        name=attack end
        first_time_only=no
        [filter]
            side=2,4
        [/filter]
        {VARIABLE_OP unit.moves add $unit.max_moves}
        [unstore_unit]
            variable=unit
            find_vacant=no
            advance=yes
        [/unstore_unit]
    [/event]

    #transfer property to allied ai and apply return guardian
    [event]
        name=side 1 turn end, side 3 turn end
        first_time_only=no
        [store_unit]
            [filter]
                side=$side_number
                canrecruit=no
            [/filter]
            variable=units_to_modify
        [/store_unit]
        {VARIABLE tower_side $side_number}
        {VARIABLE_OP tower_side add 1}
        [foreach]
            array=units_to_modify
            [do]
                [modify_unit]
                    [filter]
                        id=$this_item.id
                    [/filter]
                    side=$tower_side
                [/modify_unit]
                [micro_ai]
                    side=$tower_side
                    ca_id="micro_ai_$this_item.id|"
                    ai_type=return_guardian
                    action=add
                    [filter]
                        id=$this_item.id
                    [/filter]
                    return_x,return_y=$this_item.x,$this_item.y
                [/micro_ai]
            [/do]
        [/foreach]
        {CLEAR_VARIABLE tower_side}
        {CLEAR_VARIABLE units_to_modify}
    [/event]

    #enemy waves
    [event]
        name=side 5 turn
        first_time_only=no
        [if]
            [variable]
                name=wave_turn
                equals=0
            [/variable]
            [then]
                [message]
                    speaker=narrator
                    message=_"Wave $wave_number starts"
                [/message]
                [gold]
                    side=5,6
                    amount=$gold_increase
                [/gold]
                {VARIABLE wave_turn 10}
                {VARIABLE_OP wave_number add 1}
                [store_unit]
                    [filter]
                        side=2
                    [/filter]
                    variable=units_to_spawn
                [/store_unit]
                [store_gold]
                    side=6
                    variable=gold
                [/store_gold]
                {VARIABLE plop $side_2_location.x}
                {VARIABLE_OP plop add 42}
                {VARIABLE index 0}
                [while]
                    [variable]
                        name=gold
                        greater_than_equal_to=$units_to_spawn[$index|].cost
                    [/variable]
                    [do]
                        [gold]
                            side=6
                            amount=$(-$units_to_spawn[$index|].cost)
                        [/gold]
                        {VARIABLE units_to_spawn[$index|].side 6}
                        [unstore_unit]
                            variable=units_to_spawn[$index|]
                            x,y=$plop,$side_2_location.y
                            find_vacant=yes
                        [/unstore_unit]
                        {VARIABLE_OP index add 1}
                        {VARIABLE_OP index modulo $units_to_spawn.length}
                        [store_gold]
                            side=6
                            variable=gold
                        [/store_gold]
                    [/do]
                [/while]
                [store_unit]
                    [filter]
                        side=4
                    [/filter]
                    variable=units_to_spawn
                [/store_unit]
                [store_gold]
                    side=5
                    variable=gold
                [/store_gold]
                {VARIABLE index 0}
                [while]
                    [variable]
                        name=gold
                        greater_than_equal_to=$units_to_spawn[$index|].cost
                    [/variable]
                    [do]
                        [gold]
                            side=5
                            amount=$(-$units_to_spawn[$index|].cost)
                        [/gold]
                        {VARIABLE units_to_spawn[$index|].side 5}
                        [unstore_unit]
                            variable=units_to_spawn[$index|]
                            x,y=$side_2_location.x,$side_2_location.y
                            find_vacant=yes
                        [/unstore_unit]
                        {VARIABLE_OP index add 1}
                        {VARIABLE_OP index modulo $units_to_spawn.length}
                        [store_gold]
                            side=5
                            variable=gold
                        [/store_gold]
                    [/do]
                [/while]
                {CLEAR_VARIABLE units_to_spawn}
                {CLEAR_VARIABLE gold}
                {CLEAR_VARIABLE index}
            [/then]
        [/if]
        {VARIABLE_OP wave_turn sub 1}
        [store_gold]
            side=5
            variable=upkeep_mitigation_gold_container_1
        [/store_gold]
        [store_gold]
            side=6
            variable=upkeep_mitigation_gold_container_2
        [/store_gold]
        [objectives]
            side=1,3
            [objective]
                description= _ "Survive longer than your opponent. Next wave in $wave_turn| turns."
                condition=win
            [/objective]
            [objective]
                description= _ "Destruction of the crystal"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT}
            silent=yes
        [/objectives]
    [/event]

#no income
    [event]
        name=side 5 turn refresh
        first_time_only=no
        [modify_side]
            side=5
            gold=$upkeep_mitigation_gold_container_1
        [/modify_side]
        [clear_variable]
            name=upkeep_mitigation_gold_container_1
        [/clear_variable]
    [/event]

    [event]
        name=side 6 turn refresh
        first_time_only=no
        [modify_side]
            side=6
            gold=$upkeep_mitigation_gold_container_2
        [/modify_side]
        [clear_variable]
            name=upkeep_mitigation_gold_container_2
        [/clear_variable]
    [/event]

    #Units attacking the crystal are killed
    [event]
        name=attack end
        first_time_only=no
        [filter_second]
            id=crystal_1,crystal_2
        [/filter_second]
        [kill]
            id=$unit.id
        [/kill]
    [/event]

    #reward for killing an enemy
    [event]
        name=die
        first_time_only=no
        [filter]
            side=5,6
        [/filter]
        [switch]
            variable=second_unit.side
            [case]
                value=2
                [gold]
                    amount=$kill_gold
                    side=1
                [/gold]
            [/case]
            [case]
                value=4
                [gold]
                    amount=$kill_gold
                    side=3
                [/gold]
            [/case]
        [/switch]
        [floating_text]
            x,y=$x2,$y2
            text=_ "<span color='yellow'>+$kill_gold gold</span>"
        [/floating_text]
    [/event]

    [event]
        name=die
        [filter]
        	id=crystal_1
        [/filter]
        [kill]
        	side=6
        	canrecruit=yes
        [/kill]
    [/event]
    [event]
        name=die
        [filter]
        	id=crystal_2
        [/filter]
        [kill]
        	side=5
        	canrecruit=yes
        [/kill]
    [/event]
[/multiplayer]